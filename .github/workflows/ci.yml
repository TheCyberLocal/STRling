# .github/workflows/ci.yml
# This single file handles both CI and CD.

name: STRling CI/CD Pipeline
on:
    push:
        branches:
            - main
            - dev
            - "feature/**"
        tags:
            - "v*"
        paths:
            - "bindings/**"
            - "spec/**"
            - "tests/**"
            - "tooling/**"
            - ".github/workflows/**"
    pull_request:
        paths:
            - "bindings/**"
            - "spec/**"
            - "tests/**"
            - "tooling/**"
            - ".github/workflows/**"

jobs:
    # --- TEST JOBS (ALPHABETICALLY ORDERED) ---
    test-c:
        name: Test C (C99)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Run C test suite
              run: |
                  chmod +x strling
                  ./strling test c

    test-cpp:
        name: Test C++ (C++17)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Run C++ test suite
              run: |
                  chmod +x strling
                  ./strling setup cpp
                  ./strling build cpp
                  ./strling test cpp

    test-csharp:
        name: Test C# (.NET 9)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET 9
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0"

            - name: Run C# test suite
              run: |
                  chmod +x strling
                  ./strling setup csharp
                  ./strling test csharp

    test-dart:
        name: Test Dart (Stable)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Dart
              uses: dart-lang/setup-dart@v1

            - name: Run Dart test suite
              run: |
                  chmod +x strling
                  ./strling setup dart
                  ./strling test dart

    test-fsharp:
        name: Test F# (.NET 9)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET 9
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0"

            - name: Run F# test suite
              run: |
                  chmod +x strling
                  ./strling setup fsharp
                  ./strling test fsharp

    test-go:
        name: Test Go (1.22)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Go 1.22
              uses: actions/setup-go@v5
              with:
                  go-version: "1.22"

            - name: Run Go test suite
              run: |
                  chmod +x strling
                  ./strling setup go
                  ./strling test go

    test-java:
        name: Test Java (11 LTS)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Run Java test suite
              run: |
                  chmod +x strling
                  ./strling setup java
                  ./strling test java

    test-typescript:
        name: Test TypeScript (Node.js 22 LTS)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            # JS E2E tests call the Python CLI, so Python setup is required
            - name: Setup Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r bindings/python/requirements.txt

            - name: Install Python binding (for E2E)
              run: pip install -e bindings/python

            - name: Install JS dependencies
              run: |
                  chmod +x strling
                  ./strling setup typescript

            - name: Verify Specs (Drift Detection)
              working-directory: bindings/typescript
              run: |
                  npm run build:specs
                  git diff --exit-code ../../tests/spec

            - name: Run JS test suite
              run: ./strling test typescript

    test-kotlin:
        name: Test Kotlin (1.9.x)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java 21 (for Kotlin)
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "21"

            - name: Run Kotlin test suite
              run: |
                  chmod +x strling
                  ./strling setup kotlin
                  ./strling test kotlin

    test-lua:
        name: Test Lua (5.1+)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Lua
              uses: leafo/gh-actions-lua@v10
              with:
                  luaVersion: "5.1"

            - name: Setup LuaRocks
              uses: leafo/gh-actions-luarocks@v4

            - name: Run Lua test suite
              run: |
                  chmod +x strling
                  ./strling setup lua
                  ./strling test lua

    test-perl:
        name: Test Perl (5.32)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Perl 5.32
              uses: shogo82148/actions-setup-perl@v1
              with:
                  perl-version: "5.32"

            - name: Run Perl test suite
              run: |
                  chmod +x strling
                  ./strling setup perl
                  ./strling test perl

    test-php:
        name: Test PHP (8.2)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP 8.2
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"

            - name: Run PHP test suite
              run: |
                  chmod +x strling
                  ./strling setup php
                  ./strling test php

    test-python:
        name: Test Python (3.10)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Python build tools
              run: |
                  python -m pip install --upgrade pip build wheel

            - name: Install Python dependencies
              run: |
                  chmod +x strling
                  ./strling setup python

            - name: Install Python binding (editable)
              run: pip install -e bindings/python

            - name: Run Python test suite
              run: ./strling test python

    test-r:
        name: Test R (4.2.x)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup R 4.2
              uses: r-lib/actions/setup-r@v2
              with:
                  r-version: "4.2"

            - name: Run R test suite
              run: |
                  chmod +x strling
                  ./strling setup r
                  ./strling test r

    test-ruby:
        name: Test Ruby (3.2)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Ruby 3.2
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.2"

            - name: Run Ruby test suite
              run: |
                  chmod +x strling
                  ./strling setup ruby
                  ./strling test ruby

    test-rust:
        name: Test Rust (2021 Edition)
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Rust (1.65+)
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: "1.65"

            - name: Run Rust test suite
              run: |
                  chmod +x strling
                  ./strling setup rust
                  ./strling test rust

    test-swift:
        name: Test Swift (5.9)
        runs-on: ubuntu-22.04 # Not all Swift releases are published for 24.04 yet
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Swift 5.9
              uses: swift-actions/setup-swift@v2
              with:
                  swift-version: "5.9"

            - name: Run Swift test suite
              run: |
                  chmod +x strling
                  ./strling setup swift
                  ./strling test swift

    # --- CONFORMANCE AUDIT ---
    audit-conformance:
        name: Audit Conformance Coverage
        runs-on: ubuntu-latest
        needs: [test-python, test-java]
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Install Python dependencies
              run: |
                  chmod +x strling
                  ./strling setup python

            - name: Install Python binding (editable)
              run: pip install -e bindings/python

            - name: Run conformance audit
              run: python tooling/audit_conformance.py

    # --- DEPLOYMENT JOBS (ALPHABETICALLY ORDERED) ---
    deploy-java:
        name: Deploy Java to Maven Central
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        needs: [test-java]
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java 11
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Build and deploy to Maven Central
              working-directory: bindings/java
              run: echo "Java deployment not yet implemented" && true
              # Placeholder for future Maven deployment
              # run: mvn deploy

    deploy-typescript:
        name: Deploy TypeScript to NPM
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        needs: [test-typescript]
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python 3.10 (for SSOT script)
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Setup Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  registry-url: "https://registry.npmjs.org"

            - name: Sync Python SSOT to TypeScript Version
              run: |
                  python -c "
                  import json, tomllib

                  # 1. Read the SSOT version from Python's pyproject.toml
                  with open('bindings/python/pyproject.toml', 'rb') as f:
                      toml_data = tomllib.load(f)
                  ssot_version = toml_data['project']['version']
                  print(f'Single Source of Truth (Python) version is: {ssot_version}')

                  # 2. Load the TypeScript package.json
                  js_pkg_path = 'bindings/typescript/package.json'
                  with open(js_pkg_path, 'r') as f:
                      js_data = json.load(f)

                  original_js_version = js_data.get('version', 'N/A')

                  # 3. Update and write the new version if it's different
                  if original_js_version != ssot_version:
                      js_data['version'] = ssot_version
                      with open(js_pkg_path, 'w') as f:
                          json.dump(js_data, f, indent=2)
                      print(f'Updated TypeScript version from {original_js_version} to {ssot_version}')
                  else:
                      print(f'TypeScript version ({original_js_version}) is already in sync.')
                  "

            - name: Check NPM registry
              id: check_npm
              working-directory: bindings/typescript
              run: |
                  PACKAGE_NAME="@thecyberlocal/strling"
                  CURRENT_VERSION=$(node -pe "require('./package.json').version")

                  if python ../../tooling/check_version_exists.py --registry npm --package "$PACKAGE_NAME" --version "$CURRENT_VERSION"; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Version $CURRENT_VERSION already exists on NPM. Skipping publish."
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Version $CURRENT_VERSION not found on NPM. Proceeding to publish."
                  fi

            - name: Install JS dependencies
              if: steps.check_npm.outputs.exists == 'false'
              working-directory: bindings/typescript
              run: npm ci

            - name: Publish to NPM
              if: steps.check_npm.outputs.exists == 'false'
              working-directory: bindings/typescript
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: npm publish

    deploy-python:
        name: Deploy Python to PyPI
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        needs: [test-python]
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python 3.10
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Check PyPI registry
              id: check_pypi
              working-directory: bindings/python
              run: |
                  pip install tomli
                  VERSION=$(python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")

                  if python ../../tooling/check_version_exists.py --registry pypi --package "STRling" --version "$VERSION"; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Version $VERSION already exists on PyPI. Skipping publish."
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Version $VERSION not found on PyPI. Proceeding to publish."
                  fi

            - name: Install build tools and build package
              if: steps.check_pypi.outputs.exists == 'false'
              working-directory: bindings/python
              run: |
                  python -m pip install --upgrade pip build
                  python -m build

            - name: Publish package to PyPI
              if: steps.check_pypi.outputs.exists == 'false'
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: bindings/python/dist/

    deploy-rust:
        name: Deploy Rust to Crates.io
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        needs: [test-rust]
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: "1.65"
            - name: Check Crates.io registry
              id: check_crates
              working-directory: bindings/rust
              run: |
                  VERSION=$(grep "^version" Cargo.toml | head -n 1 | cut -d '"' -f 2)
                  if python3 ../../tooling/check_version_exists.py --registry crates --package "strling_core" --version "$VERSION"; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Version $VERSION already exists on Crates.io. Skipping publish."
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "Version $VERSION not found on Crates.io. Proceeding to publish."
                  fi
            - name: Publish to Crates.io
              if: steps.check_crates.outputs.exists == 'false'
              working-directory: bindings/rust
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}
              run: cargo publish

    deploy-csharp:
        name: Deploy C# to NuGet
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        needs: [test-csharp]
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0"
            - name: Check NuGet registry
              id: check_nuget
              working-directory: bindings/csharp
              run: |
                  VERSION=$(grep "<Version>" src/STRling/STRling.csproj | sed -e 's/.*<Version>\(.*\)<\/Version>.*/\1/')
                  if python3 ../../tooling/check_version_exists.py --registry nuget --package "STRling" --version "$VERSION"; then
                     echo "exists=true" >> $GITHUB_OUTPUT
                     echo "Version $VERSION already exists on NuGet. Skipping publish."
                  else
                     echo "exists=false" >> $GITHUB_OUTPUT
                     echo "Version $VERSION not found on NuGet. Proceeding to publish."
                  fi
            - name: Pack
              if: steps.check_nuget.outputs.exists == 'false'
              working-directory: bindings/csharp
              run: dotnet pack --configuration Release
            - name: Push to NuGet
              if: steps.check_nuget.outputs.exists == 'false'
              working-directory: bindings/csharp
              run: dotnet nuget push src/STRling/bin/Release/*.nupkg --api-key ${{ secrets.NUGET_KEY }} --source https://api.nuget.org/v3/index.json

    deploy-ruby:
        name: Deploy Ruby to RubyGems
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        needs: [test-ruby]
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.2"
            - name: Check RubyGems registry
              id: check_rubygems
              working-directory: bindings/ruby
              run: |
                  VERSION=$(grep "spec.version =" strling.gemspec | cut -d "'" -f 2)
                  if python3 ../../tooling/check_version_exists.py --registry rubygems --package "strling" --version "$VERSION"; then
                     echo "exists=true" >> $GITHUB_OUTPUT
                     echo "Version $VERSION already exists on RubyGems. Skipping publish."
                  else
                     echo "exists=false" >> $GITHUB_OUTPUT
                     echo "Version $VERSION not found on RubyGems. Proceeding to publish."
                  fi
            - name: Build Gem
              if: steps.check_rubygems.outputs.exists == 'false'
              working-directory: bindings/ruby
              run: gem build strling.gemspec
            - name: Publish to RubyGems
              if: steps.check_rubygems.outputs.exists == 'false'
              working-directory: bindings/ruby
              env:
                  GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_KEY }}
              run: |
                  mkdir -p ~/.gem
                  cat << EOF > ~/.gem/credentials
                  ---
                  :rubygems_api_key: ${GEM_HOST_API_KEY}
                  EOF
                  chmod 0600 ~/.gem/credentials
                  gem push *.gem

    deploy-dart:
        name: Deploy Dart to Pub.dev
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        needs: [test-dart]
        permissions:
            id-token: write
        steps:
            - uses: actions/checkout@v4
            - uses: dart-lang/setup-dart@v1
            - name: Check Pub.dev registry
              id: check_pub
              working-directory: bindings/dart
              run: |
                  VERSION=$(grep "^version:" pubspec.yaml | cut -d ' ' -f 2)
                  if python3 ../../tooling/check_version_exists.py --registry pub --package "strling" --version "$VERSION"; then
                     echo "exists=true" >> $GITHUB_OUTPUT
                     echo "Version $VERSION already exists on Pub.dev. Skipping publish."
                  else
                     echo "exists=false" >> $GITHUB_OUTPUT
                     echo "Version $VERSION not found on Pub.dev. Proceeding to publish."
                  fi
            - name: Publish to Pub.dev
              if: steps.check_pub.outputs.exists == 'false'
              working-directory: bindings/dart
              run: dart pub publish --force

    deploy-lua:
        name: Deploy Lua to LuaRocks
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        needs: [test-lua]
        steps:
            - uses: actions/checkout@v4
            - uses: leafo/gh-actions-lua@v10
            - uses: leafo/gh-actions-luarocks@v4
            - name: Check LuaRocks registry
              id: check_luarocks
              working-directory: bindings/lua
              run: |
                  VERSION=$(grep "^version =" strling-scm-1.rockspec | cut -d '"' -f 2)
                  if python3 ../../tooling/check_version_exists.py --registry luarocks --package "strling" --version "$VERSION"; then
                     echo "exists=true" >> $GITHUB_OUTPUT
                     echo "Version $VERSION already exists on LuaRocks. Skipping publish."
                  else
                     echo "exists=false" >> $GITHUB_OUTPUT
                     echo "Version $VERSION not found on LuaRocks. Proceeding to publish."
                  fi
            - name: Upload to LuaRocks
              if: steps.check_luarocks.outputs.exists == 'false'
              working-directory: bindings/lua
              env:
                  LUAROCKS_API_KEY: ${{ secrets.LUA_API_KEY }}
              run: luarocks upload strling-scm-1.rockspec --api-key=${LUAROCKS_API_KEY}
