# Test Design — `unit/test_schema_validation.py`

## Purpose

This test suite verifies that the JSON artifacts produced by the STRling compiler are structurally correct and conform to the official JSON Schema definitions. It acts as a critical contract test, ensuring that the output of the Python implementation adheres to the formal specification.

## Description

The STRling compiler's final output is a `TargetArtifact`, a JSON object whose structure is formally defined by `base.schema.json` and its extensions (like `pcre2.v1.schema.json`). This test suite uses the `validator.py` utility to confirm that the artifacts generated from various DSL patterns successfully validate against these schemas. It tests both valid artifacts ("happy path") and deliberately malformed artifacts to ensure the validation process itself is robust.

## Scope

-   **In scope:**

    -   Validating artifacts generated by `parse_to_artifact()` against `base.schema.json`.
    -   Validating artifacts that include PCRE2-specific fields against `pcre2.v1.schema.json`.
    -   Testing both valid and invalid artifact structures to confirm the validator raises `jsonschema.ValidationError` when appropriate.

-   **Out of scope:**
    -   The semantic correctness of the artifact's _values_ (e.g., whether a `+` quantifier correctly becomes `min=1, max='Inf'`). This is covered by other unit tests (e.g., `test_quantifiers.py`). This suite is concerned only with the artifact's **structure**.
    -   The performance of the validation process.

## Categories of Tests

### Category A — Positive Cases (Valid Artifacts)

-   **Minimal Artifact**: Parse a simple DSL string (e.g., `a`) and validate the resulting artifact against `base.schema.json`.
-   **Comprehensive Artifact**: Parse a complex DSL string that intentionally uses every major AST node type (`Alt`, `Seq`, `Quant`, `Group`, `Look`, `Backref`, `CharClass` with all `ClassItem` variants). Validate this large, nested artifact against `base.schema.json` to ensure full structural coverage.
-   **PCRE2-Specific Artifact**: Manually add the required `emitter` and `compat` fields to a valid artifact and validate it against `pcre2.v1.schema.json` to test the extension schema.

### Category B — Negative Cases (Invalid Artifacts)

These tests confirm that the validator is working correctly by attempting to validate deliberately malformed Python dictionaries against the schemas and asserting that a `ValidationError` is raised.

-   **Missing Required Property**: Construct an artifact dictionary missing a top-level required key, such as `"root"`.
-   **Incorrect Data Type**: Construct an artifact where a property has the wrong type, such as `flags.ignoreCase: "true"` (a string instead of a boolean).
-   **Invalid Enum Value**: Construct an artifact with a node that has an invalid `enum` value, such as `{"kind": "Anchor", "at": "InvalidPosition"}`.
-   **Additional Unexpected Properties**: Construct an artifact with an extra, undefined property at the top level (e.g., `"extraField": "hello"`), which should fail because `additionalProperties` is `false` in the base schema.
-   **Node-Level Structural Error**: Construct an artifact with a `Lit` node that is missing its required `"value"` property.

### Category C — Edge Cases

-   **Empty Pattern**: Parse an empty string (`""`) and validate the resulting artifact, which should represent an empty pattern.
-   **Flags-Only Artifact**: Validate an artifact generated from a source containing only a flags directive (e.g., `%flags i`).

### Category D — Cross-Semantics / Interaction

-   This category is not directly applicable, as schema validation is a self-contained structural check. The interaction is implicitly tested by validating a comprehensive artifact that represents a pattern with many interacting features.

## Completion Criteria

-   [ ] A comprehensive artifact generated from a complex DSL pattern successfully validates against `base.schema.json`.
-   [ ] An artifact with PCRE2-specific fields successfully validates against `pcre2.v1.schema.json`.
-   [ ] All major types of schema violations (missing required property, wrong data type, invalid enum, extra property) are tested and confirmed to raise a `ValidationError`.
-   [ ] The test suite confirms the path to the schema files and requires `jsonschema` as a development dependency.
